<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Image Classification</title>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <!-- Firebase Auth -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-auth-compat.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .progress-bar {
            background-color: #e0e0e0;
            height: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .progress {
            background-color: #4CAF50;
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        .image-container {
            text-align: center;
            margin: 20px 0;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-container img {
            max-width: 100%;
            max-height: 400px;
            border: 1px solid #ddd;
        }
        .buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .sequential {
            background-color: #4CAF50;
            color: white;
        }
        .sequential:hover {
            background-color: #3e8e41;
        }
        .unsequential {
            background-color: #f44336;
            color: white;
        }
        .unsequential:hover {
            background-color: #d32f2f;
        }
        .unsure {
            background-color: #ff9800;
            color: white;
        }
        .unsure:hover {
            background-color: #f57c00;
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .info-panel {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .login-container {
            text-align: center;
            padding: 20px;
        }
        .participant-selector {
            margin: 20px 0;
            text-align: center;
        }
        select, input {
            padding: 8px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .response-history {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }
        .history-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Research Image Classification</h1>
        
        <!-- Login Section -->
        <div id="loginSection" class="login-container">
            <h2>Enter your name to begin:</h2>
            <input type="text" id="researcherName" placeholder="Your Name">
            <button id="loginButton" style="background-color: #2196F3; color: white; margin-top: 10px;">Start Session</button>
        </div>
        
        <!-- Main App (hidden until login) -->
        <div id="appContent" class="hidden">
            <!-- Participant Selector -->
            <div class="participant-selector">
                <label for="participantSelect">Select Participant: </label>
                <select id="participantSelect">
                    <!-- Will be populated dynamically -->
                </select>
            </div>
            
            <!-- Progress Information -->
            <div class="info-panel">
                <div id="imageInfo">Participant: <span id="currentParticipant">-</span> | Image: <span id="currentImage">-</span> of <span id="totalImages">-</span> | Trial: <span id="currentTrial">-</span></div>
                <div>Researcher: <span id="researcherNameDisplay">-</span></div>
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-bar">
                <div id="progress" class="progress" style="width: 0%"></div>
            </div>
            
            <!-- Image Display -->
            <div class="image-container">
                <img id="currentImageDisplay" src="" alt="Research image">
            </div>
            
            <!-- Classification Buttons -->
            <div class="buttons">
                <button class="sequential" id="btnSequential">Sequential</button>
                <button class="unsequential" id="btnUnsequential">Unsequential</button>
                <button class="unsure" id="btnUnsure">Unsure</button>
            </div>
            
            <!-- Navigation Buttons -->
            <div class="navigation">
                <button id="btnPrevious" style="background-color: #2196F3; color: white;">Previous</button>
                <button id="btnNext" style="background-color: #2196F3; color: white;">Next</button>
            </div>
            
            <!-- Response History -->
            <h3>Recent Classifications:</h3>
            <div id="responseHistory" class="response-history">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration - YOU NEED TO REPLACE THIS WITH YOUR OWN CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDrG2DMZ6tYg-bTfYFi_iX00iDtFaxsw8s",
            authDomain: "gaze-path-classification.firebaseapp.com",
            projectId: "gaze-path-classification",
            storageBucket: "gaze-path-classification.firebasestorage.app",
            messagingSenderId: "134564591260",
            appId: "1:134564591260:web:5024ef4cd8234fe68a5f59",
            measurementId: "G-D3CR885ZVT"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // App state
        const state = {
            researcherName: '',
            currentParticipantIndex: 0,
            currentImageIndex: 0,
            participants: [],
            responses: {},
            imagePaths: {} // Will store the image paths for each participant
        };

        // DOM Elements
        const elements = {
            loginSection: document.getElementById('loginSection'),
            appContent: document.getElementById('appContent'),
            researcherName: document.getElementById('researcherName'),
            loginButton: document.getElementById('loginButton'),
            researcherNameDisplay: document.getElementById('researcherNameDisplay'),
            participantSelect: document.getElementById('participantSelect'),
            currentParticipant: document.getElementById('currentParticipant'),
            currentImage: document.getElementById('currentImage'),
            totalImages: document.getElementById('totalImages'),
            currentTrial: document.getElementById('currentTrial'),
            currentImageDisplay: document.getElementById('currentImageDisplay'),
            progress: document.getElementById('progress'),
            btnSequential: document.getElementById('btnSequential'),
            btnUnsequential: document.getElementById('btnUnsequential'),
            btnUnsure: document.getElementById('btnUnsure'),
            btnPrevious: document.getElementById('btnPrevious'),
            btnNext: document.getElementById('btnNext'),
            responseHistory: document.getElementById('responseHistory')
        };

        // Sample data structure (replace with your actual data)
        // In a real implementation, you'd load this from a JSON file or your database
        async function setupSampleData() {
        try {
            // Your GitHub Pages base URL
            const baseUrl = 'https://[your-username].github.io/[your-repo-name]/';
            const imagesBaseUrl = `${baseUrl}images/`;
            
            // Fetch the metadata.json file
            const response = await fetch(`${baseUrl}metadata.json`);
            if (!response.ok) {
                throw new Error('Failed to load metadata');
            }
            
            const metadata = await response.json();
            
            // Clear previous data
            state.participants = [];
            state.imagePaths = {};
            
            // Process each participant
            for (const participant of metadata.participants) {
                const participantId = participant.id;
                state.participants.push(participantId);
                state.imagePaths[participantId] = [];
                
                // Process each trial for this participant
                for (const trial of participant.trials) {
                    state.imagePaths[participantId].push({
                        path: `${imagesBaseUrl}${participantId}/${trial.filename}`,
                        trialNumber: trial.trialNumber,
                        additionalVar1: trial.additionalVar1,
                        additionalVar2: trial.additionalVar2
                    });
                }
            }
            
            console.log(`Loaded ${state.participants.length} participants with their trials from metadata.`);
            if (state.participants.length > 0) {
                console.log(`First participant: ${state.participants[0]} has ${state.imagePaths[state.participants[0]].length} trials.`);
            }
            
        } catch (error) {
            console.error('Error loading metadata:', error);
            alert('Error loading participant data. Please check the console for details.');
            
            // Fall back to hardcoded participants for demo/testing
            fallbackToHardcodedData();
        }
    }

    // Fallback function in case metadata loading fails
    function fallbackToHardcodedData() {
        console.log("Using fallback hardcoded data");
        
        // Clear previous data
        state.participants = [];
        state.imagePaths = {};
        
        // Create hardcoded participants (S001-S013)
        for (let i = 1; i <= 13; i++) {
            const participantId = `S${i.toString().padStart(3, '0')}`;
            state.participants.push(participantId);
            state.imagePaths[participantId] = [];
            
            // Create some dummy trials (just for testing)
            for (let j = 1; j <= 20; j++) {
                const trialNum = j * 5; // Trials 5, 10, 15, etc.
                state.imagePaths[participantId].push({
                    path: `https://via.placeholder.com/600x400?text=${participantId}_trial${trialNum}`,
                    trialNumber: trialNum,
                    additionalVar1: j % 2 === 0 ? 'A' : 'B',
                    additionalVar2: (j % 5) + 1
                });
            }
        }
    }

        // error handling...?
        function addImageErrorHandling() {
            elements.currentImageDisplay.onerror = function() {
                console.error('Error loading image:', this.src);
                this.src = 'https://via.placeholder.com/600x400?text=Image+Not+Found';
                this.onerror = null; // Prevent infinite error loop
            };
        }

        // Initialize participants dropdown
        function setupParticipantsDropdown() {
            elements.participantSelect.innerHTML = '';
            state.participants.forEach((participant, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = participant;
                elements.participantSelect.appendChild(option);
            });
        }

        // Load responses from Firebase
        async function loadResponses() {
            try {
                const snapshot = await db.collection('imageClassifications')
                    .where('researcherName', '==', state.researcherName)
                    .get();
                
                state.responses = {};
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (!state.responses[data.participantId]) {
                        state.responses[data.participantId] = {};
                    }
                    state.responses[data.participantId][data.imageIndex] = {
                        classification: data.classification,
                        timestamp: data.timestamp,
                        id: doc.id
                    };
                });
                
                console.log('Loaded responses:', state.responses);
                updateUI();
                updateResponseHistory();
            } catch (error) {
                console.error('Error loading responses:', error);
                alert('Error loading your previous work. Please try again.');
            }
        }

        // Save classification to Firebase
        async function saveClassification(classification) {
            const participantId = state.participants[state.currentParticipantIndex];
            const imageData = state.imagePaths[participantId][state.currentImageIndex];
            
            try {
                // Check if we already have a response for this image
                const existingResponse = state.responses[participantId] && 
                                        state.responses[participantId][state.currentImageIndex];
                
                const responseData = {
                    researcherName: state.researcherName,
                    participantId: participantId,
                    imageIndex: state.currentImageIndex,
                    trialNumber: imageData.trialNumber,
                    imagePath: imageData.path,
                    classification: classification,
                    additionalVar1: imageData.additionalVar1,
                    additionalVar2: imageData.additionalVar2,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                let docRef;
                
                if (existingResponse && existingResponse.id) {
                    // Update existing document
                    docRef = db.collection('imageClassifications').doc(existingResponse.id);
                    await docRef.update(responseData);
                } else {
                    // Create new document
                    docRef = await db.collection('imageClassifications').add(responseData);
                }
                
                // Update local state
                if (!state.responses[participantId]) {
                    state.responses[participantId] = {};
                }
                
                state.responses[participantId][state.currentImageIndex] = {
                    classification: classification,
                    timestamp: new Date(),
                    id: docRef.id
                };
                
                updateResponseHistory();
                console.log('Classification saved successfully');
            } catch (error) {
                console.error('Error saving classification:', error);
                alert('Error saving your response. Please try again.');
            }
        }

        // Update the UI based on current state
        function updateUI() {
            const participantId = state.participants[state.currentParticipantIndex];
            const imageData = state.imagePaths[participantId][state.currentImageIndex];
            
            // Update info display
            elements.currentParticipant.textContent = participantId;
            elements.currentImage.textContent = state.currentImageIndex + 1;
            elements.totalImages.textContent = state.imagePaths[participantId].length;
            elements.currentTrial.textContent = imageData.trialNumber;
            
            // Update progress bar
            const progressPercentage = ((state.currentImageIndex + 1) / state.imagePaths[participantId].length) * 100;
            elements.progress.style.width = `${progressPercentage}%`;
            
            // Simply set the image source directly to the path
            elements.currentImageDisplay.src = imageData.path;
            
            // Update participant dropdown
            elements.participantSelect.value = state.currentParticipantIndex;
            
            // Highlight the current classification if it exists
            const currentResponse = state.responses[participantId] && 
                                state.responses[participantId][state.currentImageIndex];
            
            // Reset all button styles
            elements.btnSequential.style.opacity = '1';
            elements.btnUnsequential.style.opacity = '1';
            elements.btnUnsure.style.opacity = '1';
            
            // Highlight selected button if there's a previous response
            if (currentResponse) {
                if (currentResponse.classification === 'sequential') {
                    elements.btnSequential.style.opacity = '0.7';
                } else if (currentResponse.classification === 'unsequential') {
                    elements.btnUnsequential.style.opacity = '0.7';
                } else if (currentResponse.classification === 'unsure') {
                    elements.btnUnsure.style.opacity = '0.7';
                }
            }
        }



        // Update response history display
        function updateResponseHistory() {
            const participantId = state.participants[state.currentParticipantIndex];
            elements.responseHistory.innerHTML = '';
            
            if (!state.responses[participantId]) return;
            
            // Get the last 10 responses for this participant
            const entries = Object.entries(state.responses[participantId])
                .map(([imageIndex, data]) => ({ 
                    imageIndex: parseInt(imageIndex), 
                    ...data 
                }))
                .sort((a, b) => b.imageIndex - a.imageIndex)
                .slice(0, 10);
            
            entries.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'history-item';
                
                const trialData = state.imagePaths[participantId][entry.imageIndex];
                
                let classColor = '';
                if (entry.classification === 'sequential') classColor = '#4CAF50';
                else if (entry.classification === 'unsequential') classColor = '#f44336';
                else classColor = '#ff9800';
                
                item.innerHTML = `
                    <div>Trial ${trialData.trialNumber} (Image ${entry.imageIndex + 1})</div>
                    <div style="color: ${classColor}; font-weight: bold;">${entry.classification}</div>
                `;
                
                elements.responseHistory.appendChild(item);
            });
        }

        // Navigate to previous image
        function goToPrevious() {
            if (state.currentImageIndex > 0) {
                state.currentImageIndex--;
                updateUI();
            }
        }

        // Navigate to next image
        function goToNext() {
            const participantId = state.participants[state.currentParticipantIndex];
            if (state.currentImageIndex < state.imagePaths[participantId].length - 1) {
                state.currentImageIndex++;
                updateUI();
            }
        }

        // Handle classification button clicks
        function handleClassification(classification) {
            saveClassification(classification)
                .then(() => {
                    // Automatically move to next image after classification
                    goToNext();
                });
        }

        // Handle participant change
        function handleParticipantChange() {
            state.currentParticipantIndex = parseInt(elements.participantSelect.value);
            state.currentImageIndex = 0;
            updateUI();
            updateResponseHistory();
        }

        // Handle login
        function handleLogin() {
            const name = elements.researcherName.value.trim();
            if (name) {
                state.researcherName = name;
                elements.researcherNameDisplay.textContent = name;
                elements.loginSection.classList.add('hidden');
                elements.appContent.classList.remove('hidden');
                
                // Load previous responses
                loadResponses();
            } else {
                alert('Please enter your name to continue.');
            }
        }

        // Initialize the app
        // Initialize the app
        async function initApp() {
            // Setup data
            await setupSampleData();
            setupParticipantsDropdown();
            addImageErrorHandling();
            
            // Add event listeners
            elements.btnSequential.addEventListener('click', () => handleClassification('sequential'));
            elements.btnUnsequential.addEventListener('click', () => handleClassification('unsequential'));
            elements.btnUnsure.addEventListener('click', () => handleClassification('unsure'));
            elements.btnPrevious.addEventListener('click', goToPrevious);
            elements.btnNext.addEventListener('click', goToNext);
            elements.participantSelect.addEventListener('change', handleParticipantChange);
            elements.loginButton.addEventListener('click', handleLogin);
            elements.researcherName.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
        }

        // Start the app when the page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
